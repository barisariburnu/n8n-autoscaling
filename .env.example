# ============================================================================
# n8n Autoscaling Configuration
# ============================================================================
# Copy this file to .env and configure your settings
# IMPORTANT: Change all passwords, keys, and domain settings!
# ============================================================================

# ============================================================================
# PROJECT CONFIGURATION
# ============================================================================
COMPOSE_PROJECT_NAME=n8n-autoscaling
COMPOSE_FILE_PATH=/app/docker-compose.yml
GENERIC_TIMEZONE=America/New_York

# ============================================================================
# AUTOSCALING CONFIGURATION
# ============================================================================
# Minimum number of worker containers (always running)
MIN_REPLICAS=1

# Maximum number of worker containers (scale up limit)
MAX_REPLICAS=5

# Queue length threshold to trigger scaling UP
# Workers will be added when queue length exceeds this value
SCALE_UP_QUEUE_THRESHOLD=5

# Queue length threshold to trigger scaling DOWN
# Workers will be removed when queue length is below this value
SCALE_DOWN_QUEUE_THRESHOLD=1

# How often to check queue length (in seconds)
POLLING_INTERVAL_SECONDS=10

# Cooldown period between scaling actions (in seconds)
# Prevents rapid scaling oscillations
COOLDOWN_PERIOD_SECONDS=10

# Queue monitoring interval (in seconds)
POLL_INTERVAL_SECONDS=5

# Graceful shutdown timeout for workers (in seconds)
# Should be greater than your longest workflow execution time
N8N_QUEUE_BULL_GRACEFULSHUTDOWNTIMEOUT=300
N8N_GRACEFUL_SHUTDOWN_TIMEOUT=300

# ============================================================================
# REDIS CONFIGURATION
# ============================================================================
REDIS_HOST=redis
REDIS_PORT=6379

# Redis password (optional, leave empty for no password)
REDIS_PASSWORD=

# BullMQ queue configuration
QUEUE_NAME_PREFIX=bull
QUEUE_NAME=jobs
QUEUE_BULL_REDIS_HOST=redis
QUEUE_HEALTH_CHECK_ACTIVE=true

# ============================================================================
# POSTGRESQL DATABASE CONFIGURATION
# ============================================================================
POSTGRES_HOST=postgres
POSTGRES_DB=n8n
POSTGRES_USER=postgres

# ⚠️ CHANGE THIS: Use a strong password
POSTGRES_PASSWORD=CHANGE_THIS_PASSWORD

PGDATA=/var/lib/postgresql/data/pgdata
DB_TYPE=postgresdb

# ============================================================================
# n8n CORE CONFIGURATION
# ============================================================================
# ⚠️ CHANGE THESE: Set your domain names
N8N_HOST=n8n.yourdomain.com
N8N_WEBHOOK=webhook.yourdomain.com
N8N_WEBHOOK_URL=https://webhook.yourdomain.com
WEBHOOK_URL=https://webhook.yourdomain.com
N8N_EDITOR_BASE_URL=https://n8n.yourdomain.com

# Protocol and port
N8N_PROTOCOL=https
N8N_PORT=5678

# Diagnostics and logging
N8N_DIAGNOSTICS_ENABLED=false
N8N_LOG_LEVEL=info

# File permissions
N8N_USER_FOLDER=/n8n/main
N8N_SECURE_COOKIE=false
N8N_ENFORCE_SETTINGS_FILE_PERMISSIONS=false

# ⚠️ CHANGE THIS: Generate a random 32-character encryption key
# Example: openssl rand -base64 24
N8N_ENCRYPTION_KEY=CHANGE_THIS_TO_32_CHAR_KEY

# ⚠️ CHANGE THIS: Generate a strong JWT secret
N8N_USER_MANAGEMENT_JWT_SECRET=CHANGE_THIS_JWT_SECRET

# Worker service configuration
N8N_WORKER_SERVICE_NAME=n8n-worker

# ============================================================================
# n8n QUEUE MODE CONFIGURATION
# ============================================================================
EXECUTIONS_MODE=queue

# Offload manual executions to workers
OFFLOAD_MANUAL_EXECUTIONS_TO_WORKERS=true

# Task broker configuration
N8N_TASK_BROKER_URL=http://n8n:5679
N8N_COMMAND_RESPONSE_URL=http://n8n:5679
N8N_TASK_BROKER_PORT=5679

# ⚠️ CHANGE THIS: Generate a strong runner auth token
N8N_RUNNERS_AUTH_TOKEN=CHANGE_THIS_RUNNER_TOKEN

# ============================================================================
# n8n WORKER CONFIGURATION
# ============================================================================
# Number of concurrent tasks each worker can handle
N8N_CONCURRENCY_PRODUCTION_LIMIT=10

# ============================================================================
# EXTERNAL TOOLS CONFIGURATION
# ============================================================================
# Allow external modules in code nodes
NODE_FUNCTION_ALLOW_EXTERNAL=ajv,ajv-formats,puppeteer,crypto-js,ffmpeg,git,graphicsmagick,openssh-client

# Puppeteer/Chrome configuration
PUPPETEER_EXECUTABLE_PATH=/usr/bin/chromium

# ============================================================================
# CLOUDFLARE TUNNEL CONFIGURATION
# ============================================================================
# ⚠️ CHANGE THIS: Get your token from Cloudflare Zero Trust dashboard
# Instructions: https://developers.cloudflare.com/cloudflare-one/connections/connect-apps/
CLOUDFLARE_TUNNEL_TOKEN=CHANGE_THIS_TO_YOUR_CLOUDFLARE_TOKEN

# ============================================================================
# TAILSCALE CONFIGURATION (OPTIONAL)
# ============================================================================
# Set your Tailscale IP for PostgreSQL binding (optional but recommended)
# Leave empty to bind to all interfaces
TAILSCALE_IP=

# ============================================================================
# ADVANCED CONFIGURATION
# ============================================================================
# Traefik Configuration (usually no need to change)
TRAEFIK_N8N_UI_PORT=8082
TRAEFIK_N8N_WEBHOOK_PORT=8083

# ============================================================================
# NOTES
# ============================================================================
# 1. Always use strong, unique passwords and keys
# 2. Never commit the .env file to version control
# 3. Back up your .env file securely
# 4. For Cloudflare Tunnel setup: https://www.reddit.com/r/n8n/comments/1l9mi6k/
# 5. Adjust autoscaling parameters based on your workload
# 6. Monitor logs: docker compose logs -f
# ============================================================================